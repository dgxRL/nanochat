<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>base_train.py Flow Diagram</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #e0e0e0;
        }
        h1 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 0.95rem;
        }
        .diagram-container {
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: auto;
        }
        svg {
            display: block;
            margin: 0 auto;
        }
        /* Node styles */
        .node-start-end {
            fill: url(#gradientStartEnd);
            stroke: #ff6b9d;
            stroke-width: 2;
        }
        .node-process {
            fill: url(#gradientProcess);
            stroke: #4ecdc4;
            stroke-width: 2;
        }
        .node-decision {
            fill: url(#gradientDecision);
            stroke: #ffd93d;
            stroke-width: 2;
        }
        .node-loop {
            fill: url(#gradientLoop);
            stroke: #6c5ce7;
            stroke-width: 2;
        }
        .node-io {
            fill: url(#gradientIO);
            stroke: #a8e6cf;
            stroke-width: 2;
        }
        .node-label {
            fill: #ffffff;
            font-size: 11px;
            font-weight: 500;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .node-label-small {
            fill: #ffffff;
            font-size: 9px;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .arrow {
            stroke: #666;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        .arrow-yes {
            stroke: #4ecdc4;
        }
        .arrow-no {
            stroke: #ff6b6b;
        }
        .section-label {
            fill: #888;
            font-size: 10px;
            font-style: italic;
        }
        .legend {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .legend-start { background: linear-gradient(135deg, #ff6b9d, #c44569); }
        .legend-process { background: linear-gradient(135deg, #4ecdc4, #2d9a8c); }
        .legend-decision { background: linear-gradient(135deg, #ffd93d, #f39c12); }
        .legend-loop { background: linear-gradient(135deg, #6c5ce7, #5541d7); }
        .legend-io { background: linear-gradient(135deg, #a8e6cf, #7bc9a5); }
    </style>
</head>
<body>
    <h1>base_train.py Flow Diagram</h1>
    <p class="subtitle">NanoChat Base Model Training Script Flow</p>
    
    <div class="diagram-container">
        <svg width="1100" height="2200" viewBox="0 0 1100 2200">
            <defs>
                <!-- Gradients -->
                <linearGradient id="gradientStartEnd" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff6b9d"/>
                    <stop offset="100%" style="stop-color:#c44569"/>
                </linearGradient>
                <linearGradient id="gradientProcess" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#4ecdc4"/>
                    <stop offset="100%" style="stop-color:#2d9a8c"/>
                </linearGradient>
                <linearGradient id="gradientDecision" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ffd93d"/>
                    <stop offset="100%" style="stop-color:#f39c12"/>
                </linearGradient>
                <linearGradient id="gradientLoop" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#6c5ce7"/>
                    <stop offset="100%" style="stop-color:#5541d7"/>
                </linearGradient>
                <linearGradient id="gradientIO" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#a8e6cf"/>
                    <stop offset="100%" style="stop-color:#7bc9a5"/>
                </linearGradient>
                <!-- Arrow marker -->
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
                </marker>
                <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#4ecdc4"/>
                </marker>
                <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#ff6b6b"/>
                </marker>
            </defs>

            <!-- ==================== INITIALIZATION SECTION ==================== -->
            <text x="550" y="25" class="section-label" text-anchor="middle">INITIALIZATION PHASE</text>
            
            <!-- Start -->
            <ellipse cx="550" cy="60" rx="60" ry="25" class="node-start-end"/>
            <text x="550" y="60" class="node-label">START</text>
            
            <!-- Parse CLI Args -->
            <path d="M 475 110 L 625 110 L 595 150 L 505 150 Z" class="node-io"/>
            <text x="550" y="130" class="node-label">Parse CLI Arguments</text>
            <line x1="550" y1="85" x2="550" y2="110" class="arrow"/>

            <!-- Compute Init -->
            <rect x="450" y="170" width="200" height="40" rx="5" class="node-process"/>
            <text x="550" y="185" class="node-label-small">Compute Init (DDP, Device)</text>
            <text x="550" y="200" class="node-label-small">autocast_ctx, synchronize</text>
            <line x1="550" y1="150" x2="550" y2="170" class="arrow"/>

            <!-- Init Wandb -->
            <rect x="450" y="230" width="200" height="35" rx="5" class="node-process"/>
            <text x="550" y="252" class="node-label">Initialize Wandb Logging</text>
            <line x1="550" y1="210" x2="550" y2="230" class="arrow"/>

            <!-- Load Tokenizer -->
            <rect x="450" y="285" width="200" height="35" rx="5" class="node-process"/>
            <text x="550" y="307" class="node-label">Load Tokenizer</text>
            <line x1="550" y1="265" x2="550" y2="285" class="arrow"/>

            <!-- Calculate Model Arch -->
            <rect x="430" y="340" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="355" class="node-label-small">Calculate Model Architecture</text>
            <text x="550" y="372" class="node-label-small">depth, model_dim, num_heads</text>
            <line x1="550" y1="320" x2="550" y2="340" class="arrow"/>

            <!-- Calculate Batch/Grad Accum -->
            <rect x="430" y="405" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="420" class="node-label-small">Calculate Batch Settings</text>
            <text x="550" y="437" class="node-label-small">grad_accum_steps, batch_lr_scale</text>
            <line x1="550" y1="385" x2="550" y2="405" class="arrow"/>

            <!-- ==================== MODEL INIT SECTION ==================== -->
            <text x="550" y="475" class="section-label" text-anchor="middle">MODEL INITIALIZATION</text>

            <!-- Create Model -->
            <rect x="430" y="490" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="505" class="node-label-small">Create GPT Model (meta device)</text>
            <text x="550" y="522" class="node-label-small">→ to_empty() → init_weights()</text>
            <line x1="550" y1="450" x2="550" y2="490" class="arrow"/>

            <!-- Resume Decision -->
            <polygon points="550,555 630,595 550,635 470,595" class="node-decision"/>
            <text x="550" y="595" class="node-label">Resume?</text>
            <line x1="550" y1="535" x2="550" y2="555" class="arrow"/>

            <!-- Load Checkpoint (Yes branch) -->
            <rect x="700" y="575" width="180" height="40" rx="5" class="node-io"/>
            <text x="790" y="600" class="node-label">Load Checkpoint</text>
            <line x1="630" y1="595" x2="700" y2="595" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <text x="655" y="588" fill="#4ecdc4" font-size="10">Yes</text>
            
            <!-- Merge point after resume -->
            <line x1="790" y1="615" x2="790" y2="660" class="arrow"/>
            <line x1="790" y1="660" x2="550" y2="660" class="arrow"/>

            <!-- Compile Model -->
            <rect x="430" y="680" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="695" class="node-label-small">torch.compile(model)</text>
            <text x="550" y="712" class="node-label-small">Calculate num_params, FLOPs</text>
            <line x1="550" y1="635" x2="550" y2="680" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>
            <text x="515" y="658" fill="#ff6b6b" font-size="10">No</text>

            <!-- Calculate Iterations -->
            <polygon points="550,745 650,790 550,835 450,790" class="node-decision"/>
            <text x="550" y="785" class="node-label-small">Calculate</text>
            <text x="550" y="798" class="node-label-small">num_iterations</text>
            <line x1="550" y1="725" x2="550" y2="745" class="arrow"/>

            <!-- Three branches for iteration calc -->
            <rect x="200" y="770" width="140" height="35" rx="5" class="node-process"/>
            <text x="270" y="792" class="node-label-small">from --num_iterations</text>
            
            <rect x="760" y="770" width="140" height="35" rx="5" class="node-process"/>
            <text x="830" y="792" class="node-label-small">from target_flops</text>
            
            <rect x="760" y="820" width="160" height="35" rx="5" class="node-process"/>
            <text x="840" y="842" class="node-label-small">from param_data_ratio</text>
            
            <line x1="450" y1="790" x2="340" y2="790" class="arrow"/>
            <line x1="650" y1="790" x2="760" y2="790" class="arrow"/>
            <line x1="650" y1="790" x2="700" y2="837" class="arrow"/>
            <line x1="700" y1="837" x2="760" y2="837" class="arrow"/>

            <!-- Setup Optimizers -->
            <rect x="430" y="880" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="895" class="node-label-small">Setup Optimizers</text>
            <text x="550" y="912" class="node-label-small">AdamW (embed) + Muon (matrix)</text>
            <line x1="550" y1="835" x2="550" y2="880" class="arrow"/>

            <!-- Load Optimizer State if Resuming -->
            <polygon points="550,945 620,975 550,1005 480,975" class="node-decision"/>
            <text x="550" y="975" class="node-label-small">Resume?</text>
            <line x1="550" y1="925" x2="550" y2="945" class="arrow"/>

            <rect x="680" y="955" width="160" height="35" rx="5" class="node-io"/>
            <text x="760" y="977" class="node-label-small">Load optimizer states</text>
            <line x1="620" y1="975" x2="680" y2="975" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <line x1="760" y1="990" x2="760" y2="1030" class="arrow"/>
            <line x1="760" y1="1030" x2="550" y2="1030" class="arrow"/>

            <!-- Init DataLoaders -->
            <rect x="430" y="1050" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="1065" class="node-label-small">Initialize DataLoaders</text>
            <text x="550" y="1082" class="node-label-small">train_loader, build_val_loader</text>
            <line x1="550" y1="1005" x2="550" y2="1050" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>

            <!-- Setup Schedulers -->
            <rect x="430" y="1115" width="240" height="45" rx="5" class="node-process"/>
            <text x="550" y="1130" class="node-label-small">Setup LR & Momentum Schedulers</text>
            <text x="550" y="1147" class="node-label-small">get_lr_multiplier, get_muon_momentum</text>
            <line x1="550" y1="1095" x2="550" y2="1115" class="arrow"/>

            <!-- Init Loop State -->
            <rect x="430" y="1180" width="240" height="40" rx="5" class="node-process"/>
            <text x="550" y="1205" class="node-label">Initialize Loop State</text>
            <line x1="550" y1="1160" x2="550" y2="1180" class="arrow"/>

            <!-- ==================== TRAINING LOOP ==================== -->
            <text x="550" y="1250" class="section-label" text-anchor="middle">TRAINING LOOP (while True)</text>
            
            <!-- Training Loop Start -->
            <rect x="460" y="1270" width="180" height="35" rx="8" class="node-loop"/>
            <text x="550" y="1292" class="node-label">Training Loop Start</text>
            <line x1="550" y1="1220" x2="550" y2="1270" class="arrow"/>

            <!-- Eval Val BPB -->
            <polygon points="550,1325 640,1360 550,1395 460,1360" class="node-decision"/>
            <text x="550" y="1355" class="node-label-small">eval_every?</text>
            <text x="550" y="1368" class="node-label-small">or last_step?</text>
            <line x1="550" y1="1305" x2="550" y2="1325" class="arrow"/>

            <rect x="700" y="1340" width="160" height="40" rx="5" class="node-process"/>
            <text x="780" y="1355" class="node-label-small">Evaluate Val BPB</text>
            <text x="780" y="1370" class="node-label-small">Log to wandb</text>
            <line x1="640" y1="1360" x2="700" y2="1360" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <line x1="780" y1="1380" x2="780" y2="1410" class="arrow"/>
            <line x1="780" y1="1410" x2="550" y2="1410" class="arrow"/>

            <!-- Eval CORE Metric -->
            <polygon points="550,1420 650,1455 550,1490 450,1455" class="node-decision"/>
            <text x="550" y="1450" class="node-label-small">core_metric_</text>
            <text x="550" y="1463" class="node-label-small">every?</text>
            <line x1="550" y1="1395" x2="550" y2="1420" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>

            <rect x="700" y="1435" width="160" height="40" rx="5" class="node-process"/>
            <text x="780" y="1450" class="node-label-small">Evaluate CORE Metric</text>
            <text x="780" y="1465" class="node-label-small">Log to wandb</text>
            <line x1="650" y1="1455" x2="700" y2="1455" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <line x1="780" y1="1475" x2="780" y2="1505" class="arrow"/>
            <line x1="780" y1="1505" x2="550" y2="1505" class="arrow"/>

            <!-- Sample from Model -->
            <polygon points="550,1515 640,1550 550,1585 460,1550" class="node-decision"/>
            <text x="550" y="1545" class="node-label-small">sample_every?</text>
            <text x="550" y="1558" class="node-label-small">& master?</text>
            <line x1="550" y1="1490" x2="550" y2="1515" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>

            <rect x="700" y="1530" width="160" height="40" rx="5" class="node-process"/>
            <text x="780" y="1545" class="node-label-small">Generate Samples</text>
            <text x="780" y="1560" class="node-label-small">using Engine</text>
            <line x1="640" y1="1550" x2="700" y2="1550" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <line x1="780" y1="1570" x2="780" y2="1600" class="arrow"/>
            <line x1="780" y1="1600" x2="550" y2="1600" class="arrow"/>

            <!-- Save Checkpoint -->
            <polygon points="550,1610 640,1645 550,1680 460,1645" class="node-decision"/>
            <text x="550" y="1640" class="node-label-small">save_every?</text>
            <text x="550" y="1653" class="node-label-small">or last_step?</text>
            <line x1="550" y1="1585" x2="550" y2="1610" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>

            <rect x="700" y="1625" width="160" height="40" rx="5" class="node-io"/>
            <text x="780" y="1640" class="node-label-small">Save Checkpoint</text>
            <text x="780" y="1655" class="node-label-small">model, opt, meta</text>
            <line x1="640" y1="1645" x2="700" y2="1645" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <line x1="780" y1="1665" x2="780" y2="1695" class="arrow"/>
            <line x1="780" y1="1695" x2="550" y2="1695" class="arrow"/>

            <!-- Last Step Check -->
            <polygon points="550,1705 620,1735 550,1765 480,1735" class="node-decision"/>
            <text x="550" y="1738" class="node-label-small">last_step?</text>
            <line x1="550" y1="1680" x2="550" y2="1705" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>

            <!-- Break to End -->
            <line x1="620" y1="1735" x2="950" y2="1735" class="arrow arrow-yes" style="marker-end: url(#arrowhead-yes)"/>
            <text x="660" y="1728" fill="#4ecdc4" font-size="10">Yes → break</text>

            <!-- ==================== TRAINING STEP ==================== -->
            <text x="300" y="1795" class="section-label" text-anchor="middle">SINGLE TRAINING STEP</text>

            <!-- Gradient Accumulation Loop -->
            <rect x="160" y="1810" width="280" height="55" rx="8" class="node-loop"/>
            <text x="300" y="1830" class="node-label-small">for micro_step in grad_accum_steps:</text>
            <text x="300" y="1850" class="node-label-small">loss = model(x, y) → loss.backward()</text>
            <line x1="550" y1="1765" x2="550" y2="1785" class="arrow arrow-no" style="marker-end: url(#arrowhead-no)"/>
            <line x1="550" y1="1785" x2="300" y2="1785" class="arrow"/>
            <line x1="300" y1="1785" x2="300" y2="1810" class="arrow"/>

            <!-- Update LR -->
            <rect x="180" y="1885" width="240" height="40" rx="5" class="node-process"/>
            <text x="300" y="1900" class="node-label-small">Update Learning Rates</text>
            <text x="300" y="1915" class="node-label-small">lrm = get_lr_multiplier(step)</text>
            <line x1="300" y1="1865" x2="300" y2="1885" class="arrow"/>

            <!-- Optimizer Step -->
            <rect x="180" y="1945" width="240" height="40" rx="5" class="node-process"/>
            <text x="300" y="1960" class="node-label-small">optimizer.step()</text>
            <text x="300" y="1975" class="node-label-small">model.zero_grad()</text>
            <line x1="300" y1="1925" x2="300" y2="1945" class="arrow"/>

            <!-- Logging -->
            <rect x="180" y="2005" width="240" height="40" rx="5" class="node-process"/>
            <text x="300" y="2020" class="node-label-small">Logging (print, wandb)</text>
            <text x="300" y="2035" class="node-label-small">loss, MFU, tok/sec, ETA</text>
            <line x1="300" y1="1985" x2="300" y2="2005" class="arrow"/>

            <!-- Increment Step -->
            <rect x="220" y="2065" width="160" height="35" rx="5" class="node-process"/>
            <text x="300" y="2087" class="node-label">step += 1</text>
            <line x1="300" y1="2045" x2="300" y2="2065" class="arrow"/>

            <!-- Loop back arrow -->
            <line x1="300" y1="2100" x2="300" y2="2120" class="arrow"/>
            <line x1="300" y1="2120" x2="100" y2="2120" stroke="#666" stroke-width="2"/>
            <line x1="100" y1="2120" x2="100" y2="1290" stroke="#666" stroke-width="2"/>
            <line x1="100" y1="1290" x2="460" y2="1290" class="arrow"/>

            <!-- ==================== FINALIZATION ==================== -->
            <text x="950" y="1775" class="section-label" text-anchor="middle">FINALIZATION</text>

            <!-- Print Stats -->
            <rect x="870" y="1790" width="160" height="40" rx="5" class="node-process"/>
            <text x="950" y="1805" class="node-label-small">Print Final Stats</text>
            <text x="950" y="1820" class="node-label-small">memory, time, bpb</text>
            <line x1="950" y1="1735" x2="950" y2="1790" class="arrow"/>

            <!-- Log to Report -->
            <rect x="870" y="1850" width="160" height="35" rx="5" class="node-io"/>
            <text x="950" y="1872" class="node-label">Log to Report</text>
            <line x1="950" y1="1830" x2="950" y2="1850" class="arrow"/>

            <!-- Cleanup -->
            <rect x="870" y="1905" width="160" height="40" rx="5" class="node-process"/>
            <text x="950" y="1920" class="node-label-small">wandb.finish()</text>
            <text x="950" y="1935" class="node-label-small">compute_cleanup()</text>
            <line x1="950" y1="1885" x2="950" y2="1905" class="arrow"/>

            <!-- End -->
            <ellipse cx="950" cy="1980" rx="50" ry="25" class="node-start-end"/>
            <text x="950" y="1980" class="node-label">END</text>
            <line x1="950" y1="1945" x2="950" y2="1955" class="arrow"/>

        </svg>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-box legend-start"></div>
            <span>Start/End</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-process"></div>
            <span>Process</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-decision"></div>
            <span>Decision</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-loop"></div>
            <span>Loop</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-io"></div>
            <span>I/O (Load/Save)</span>
        </div>
    </div>
</body>
</html>
